name: Contract Test (Nightly)

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to test against"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  contract-test-staging:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    env:
      RHIZ_API_URL: ${{ secrets.RHIZ_API_URL_STAGING }}
      RHIZ_API_TOKEN: ${{ secrets.RHIZ_API_TOKEN_STAGING }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Contract Tests
        id: contract-test
        run: npx tsx scripts/contract-test.ts

      - name: Generate Report
        if: always()
        run: |
          echo "# Nightly Contract Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** $RHIZ_API_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Contract Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Header | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| X-Rhiz-App-Id | eventmanage |" >> $GITHUB_STEP_SUMMARY
          echo "| X-Rhiz-Contract-Version | 1.0 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Endpoints Tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- GET /v1/protocol/me" >> $GITHUB_STEP_SUMMARY
          echo "- GET /v1/protocol/graph/summary" >> $GITHUB_STEP_SUMMARY
          echo "- GET /v1/subscriptions/plan" >> $GITHUB_STEP_SUMMARY
          echo "- GET /v1/subscriptions/capabilities" >> $GITHUB_STEP_SUMMARY
          echo "- GET /v1/registry/modules" >> $GITHUB_STEP_SUMMARY
          echo "- POST /v1/protocol/events/ingest" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            core.setFailed('Nightly contract tests failed. Please check the workflow run for details.');

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `ðŸš¨ Nightly Contract Test Failure - ${date}`;
            const body = `## Contract Test Failure

            The nightly contract test against the **${{ github.event.inputs.environment || 'staging' }}** environment failed.

            **Workflow Run:** [View Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ### Required Action
            1. Check if the Protocol API is available
            2. Verify contract v1 endpoints are responding
            3. Check for any recent backend changes

            ### Contract Requirements
            - All requests must include \`X-Rhiz-App-Id: eventmanage\`
            - All requests must include \`X-Rhiz-Contract-Version: 1.0\`
            - Core endpoints must return 200/201 on success
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'protocol', 'automated']
            });
